var Reader=function(e){this.type=e||Reader.OPEN_URI,this.size=null,this.file=null};if(Reader.OPEN_FILE=1,Reader.OPEN_URI=2,Reader.OPEN_LOCAL=3,"function"==typeof require)var fs=require("fs");Reader.prototype.open=function(e,i){this.file=e;var n=this;switch(this.type){case Reader.OPEN_LOCAL:fs.stat(this.file,function(e,t){if(e)return i(e);n.size=t.size,fs.open(n.file,"r",function(e,t){if(e)return i(e);n.fd=t,i()})});break;case Reader.OPEN_FILE:this.size=this.file.size,i();break;default:this.ajax({uri:this.file,type:"HEAD"},function(e,t,r){if(e)return i(e);n.size=parseInt(r.getResponseHeader("Content-Length")),i()})}},Reader.prototype.close=function(){this.type===Reader.OPEN_LOCAL&&fs.close(this.fd)},Reader.prototype.read=function(e,t,r){this.type===Reader.OPEN_LOCAL?this.readLocal(e,t,r):this.type===Reader.OPEN_FILE?this.readFile(e,t,r):this.readUri(e,t,r)},Reader.prototype.readLocal=function(e,t,o){var r=new Buffer(e);fs.read(this.fd,r,0,e,t,function(e,t,r){if(e)return o(e);for(var i=new ArrayBuffer(r.length),n=new Uint8Array(i),a=0;a<r.length;a++)n[a]=r[a];o(null,i)})},Reader.prototype.ajax=function(e,t){var r={type:"GET",uri:null,responseType:"text"};for(var i in"string"==typeof e&&(e={uri:e}),e)r[i]=e[i];var n=new XMLHttpRequest;n.onreadystatechange=function(){if(4===n.readyState)return 200!==n.status&&206!==n.status?t("Received non-200/206 response ("+n.status+")"):void t(null,n.response,n)},n.responseType=r.responseType,n.open(r.type,r.uri,!0),r.range&&(r.range=[].concat(r.range),2===r.range.length?n.setRequestHeader("Range","bytes="+r.range[0]+"-"+r.range[1]):n.setRequestHeader("Range","bytes="+r.range[0])),n.send()},Reader.prototype.readUri=function(e,t,r){this.ajax({uri:this.file,type:"GET",responseType:"arraybuffer",range:[t,t+e-1]},function(e,t){return e?r(e):r(null,t)})},Reader.prototype.readFile=function(e,t,r){var i=this.file.slice(t,t+e),n=new FileReader;n.onload=function(e){r(null,e.target.result)},n.onerror=function(e){r("File read failed")},n.readAsArrayBuffer(i)},DataView.prototype.getString=function(e,t,r){t=t||0,(e=e||this.byteLength-t)<0&&(e+=this.byteLength);var i="";if("undefined"!=typeof Buffer){for(var n=[],a=t;a<t+e;a++)n.push(this.getUint8(a));return new Buffer(n).toString()}for(a=t;a<t+e;a++)i+=String.fromCharCode(this.getUint8(a));return r?i:decodeURIComponent(escape(i))},DataView.prototype.getStringUtf16=function(e,t,r){t=t||0,e=e||this.byteLength-t;var i=!1,n="",a=!1;("undefined"!=typeof Buffer&&(n=[],a=!0),e<0&&(e+=this.byteLength),r)&&(65534===this.getUint16(t)&&(i=!0),t+=2,e-=2);for(var o=t;o<t+e;o+=2){var l=this.getUint16(o,i);0<=l&&l<=55295||57344<=l&&l<=65535?a?n.push(l):n+=String.fromCharCode(l):65536<=l&&l<=1114111&&(l-=65536,a?(n.push(55296+((1047552&l)>>10)),n.push(56320+(1023&l))):n+=String.fromCharCode(55296+((1047552&l)>>10))+String.fromCharCode(56320+(1023&l)))}return a?n.toString():decodeURIComponent(escape(n))},DataView.prototype.getSynch=function(e){for(var t=0,r=2130706432;r;)t>>=1,t|=e&r,r>>=8;return t},DataView.prototype.getUint8Synch=function(e){return this.getSynch(this.getUint8(e))},DataView.prototype.getUint32Synch=function(e){return this.getSynch(this.getUint32(e))},DataView.prototype.getUint24=function(e,t){return t?this.getUint8(e)+(this.getUint8(e+1)<<8)+(this.getUint8(e+2)<<16):this.getUint8(e+2)+(this.getUint8(e+1)<<8)+(this.getUint8(e)<<16)};var ID3Genres=["Blues","Classic Rock","Country","Dance","Disco","Funk","Grunge","Hip-Hop","Jazz","Metal","New Age","Oldies","Other","Pop","R&B","Rap","Reggae","Rock","Techno","Industrial","Alternative","Ska","Death Metal","Pranks","Soundtrack","Euro-Techno","Ambient","Trip-Hop","Vocal","Jazz+Funk","Fusion","Trance","Classical","Instrumental","Acid","House","Game","Sound Clip","Gospel","Noise","AlternRock","Bass","Soul","Punk","Space","Meditative","Instrumental Pop","Instrumental Rock","Ethnic","Gothic","Darkwave","Techno-Industrial","Electronic","Pop-Folk","Eurodance","Dream","Southern Rock","Comedy","Cult","Gangsta Rap","Top 40","Christian Rap","Pop / Funk","Jungle","Native American","Cabaret","New Wave","Psychedelic","Rave","Showtunes","Trailer","Lo-Fi","Tribal","Acid Punk","Acid Jazz","Polka","Retro","Musical","Rock & Roll","Hard Rock","Folk","Folk-Rock","National Folk","Swing","Fast  Fusion","Bebob","Latin","Revival","Celtic","Bluegrass","Avantgarde","Gothic Rock","Progressive Rock","Psychedelic Rock","Symphonic Rock","Slow Rock","Big Band","Chorus","Easy Listening","Acoustic","Humour","Speech","Chanson","Opera","Chamber Music","Sonata","Symphony","Booty Bass","Primus","Porn Groove","Satire","Slow Jam","Club","Tango","Samba","Folklore","Ballad","Power Ballad","Rhythmic Soul","Freestyle","Duet","Punk Rock","Drum Solo","A Cappella","Euro-House","Dance Hall","Goa","Drum & Bass","Club-House","Hardcore","Terror","Indie","BritPop","Negerpunk","Polsk Punk","Beat","Christian Gangsta Rap","Heavy Metal","Black Metal","Crossover","Contemporary Christian","Christian Rock","Merengue","Salsa","Thrash Metal","Anime","JPop","Synthpop","Rock/Pop"],ID3Frame={types:{TALB:"album",TBPM:"bpm",TCOM:"composer",TCON:"genre",TCOP:"copyright",TDEN:"encoding-time",TDLY:"playlist-delay",TDOR:"original-release-time",TDRC:"recording-time",TDRL:"release-time",TDTG:"tagging-time",TENC:"encoder",TEXT:"writer",TFLT:"file-type",TIPL:"involved-people",TIT1:"content-group",TIT2:"title",TIT3:"subtitle",TKEY:"initial-key",TLAN:"language",TLEN:"length",TMCL:"credits",TMED:"media-type",TMOO:"mood",TOAL:"original-album",TOFN:"original-filename",TOLY:"original-writer",TOPE:"original-artist",TOWN:"owner",TPE1:"artist",TPE2:"band",TPE3:"conductor",TPE4:"remixer",TPOS:"set-part",TPRO:"produced-notice",TPUB:"publisher",TRCK:"track",TRSN:"radio-name",TRSO:"radio-owner",TSOA:"album-sort",TSOP:"performer-sort",TSOT:"title-sort",TSRC:"isrc",TSSE:"encoder-settings",TSST:"set-subtitle",TAL:"album",TBP:"bpm",TCM:"composer",TCO:"genre",TCR:"copyright",TDY:"playlist-delay",TEN:"encoder",TFT:"file-type",TKE:"initial-key",TLA:"language",TLE:"length",TMT:"media-type",TOA:"original-artist",TOF:"original-filename",TOL:"original-writer",TOT:"original-album",TP1:"artist",TP2:"band",TP3:"conductor",TP4:"remixer",TPA:"set-part",TPB:"publisher",TRC:"isrc",TRK:"track",TSS:"encoder-settings",TT1:"content-group",TT2:"title",TT3:"subtitle",TXT:"writer",WCOM:"url-commercial",WCOP:"url-legal",WOAF:"url-file",WOAR:"url-artist",WOAS:"url-source",WORS:"url-radio",WPAY:"url-payment",WPUB:"url-publisher",WAF:"url-file",WAR:"url-artist",WAS:"url-source",WCM:"url-commercial",WCP:"url-copyright",WPB:"url-publisher",COMM:"comments",APIC:"image",PIC:"image"},imageTypes:["other","file-icon","icon","cover-front","cover-back","leaflet","media","artist-lead","artist","conductor","band","composer","writer","location","during-recording","during-performance","screen","fish","illustration","logo-band","logo-publisher"],parse:function(e,t,r){r=r||0,t=t||4;var i={tag:null,value:null},n=new DataView(e);if(t<3)return ID3Frame.parseLegacy(e);var a=n.getString(4),o=n.getString(1);n.getUint32Synch(4);if(0!==[n.getUint8(8),n.getUint8(9)][1])return!1;if(!a in ID3Frame.types)return!1;if(i.tag=ID3Frame.types[a],"T"===o){if(0===(l=n.getUint8(10))||3===l)i.value=n.getString(-11,11);else if(1===l)i.value=n.getStringUtf16(-11,11,!0);else{if(2!==l)return!1;i.value=n.getStringUtf16(-11,11)}"TCON"===a&&parseInt(i.value)&&(i.value=ID3Genres[parseInt(i.value)])}else if("W"===o)i.value=n.getString(-10,10);else if("COMM"===a){for(var l=n.getUint8(10),s=0,u=g=14;;u++)if(1===l||2===l){if(0===n.getUint16(u)){g=u+2;break}u++}else if(0===n.getUint8(u)){g=u+1;break}if(0===l||3===l)i.value=n.getString(-1*g,g);else if(1===l)i.value=n.getStringUtf16(-1*g,g,!0);else{if(2!==l)return!1;i.value=n.getStringUtf16(-1*g,g)}}else if("APIC"===a){l=n.getUint8(10);var g,c={type:null,mime:null,description:null,data:null};for(s=0,u=g=11;;u++)if(0===n.getUint8(u)){s=u-g;break}c.mime=n.getString(s,g),c.type=ID3Frame.imageTypes[n.getUint8(g+s+1)]||"other",g+=s+2,s=0;for(u=g;;u++)if(0===n.getUint8(u)){s=u-g;break}c.description=0===s?null:n.getString(s,g),c.data=e.slice(g+1),i.value=c}return!!i.tag&&i},parseLegacy:function(e){var t={tag:null,value:null},r=new DataView(e),i=r.getString(3),n=r.getString(1);r.getUint24(3);if(!i in ID3Frame.types)return!1;if(t.tag=ID3Frame.types[i],"T"===n){r.getUint8(7);t.value=r.getString(-7,7),"TCO"===i&&parseInt(t.value)&&(t.value=ID3Genres[parseInt(t.value)])}else if("W"===n)t.value=r.getString(-7,7);else if("COM"===i){r.getUint8(6);t.value=r.getString(-10,10),-1!==t.value.indexOf("\0")&&(t.value=t.value.substr(t.value.indexOf("\0")+1))}else if("PIC"===i){r.getUint8(6);var a={type:null,mime:"image/"+r.getString(3,7).toLowerCase(),description:null,data:null};a.type=ID3Frame.imageTypes[r.getUint8(11)]||"other";for(var o=0,l=11;;l++)if(0===r.getUint8(l)){o=l-11;break}a.description=0===o?null:r.getString(o,11),a.data=e.slice(12),t.value=a}return!!t.tag&&t}},ID3Tag={parse:function(o,l){var u={title:null,album:null,artist:null,year:null,v1:{title:null,artist:null,album:null,year:null,comment:null,track:null,version:1},v2:{version:[null,null]}},g={v1:!1,v2:!1},c=function(){g.v1&&g.v2&&(u.title=u.v2.title||u.v1.title,u.album=u.v2.album||u.v1.album,u.artist=u.v2.artist||u.v1.artist,u.year=u.v1.year,l(null,u))};o.read(128,o.size-128,function(e,t){if(e)return l("Could not read file");var r=new DataView(t);if(128!==t.byteLength||"TAG"!==r.getString(3,null,!0))return g.v1=!0,c();u.v1.title=r.getString(30,3).replace(/(^\s+|\s+$)/,"")||null,u.v1.artist=r.getString(30,33).replace(/(^\s+|\s+$)/,"")||null,u.v1.album=r.getString(30,63).replace(/(^\s+|\s+$)/,"")||null,u.v1.year=r.getString(4,93).replace(/(^\s+|\s+$)/,"")||null,0===r.getUint8(125)?(u.v1.comment=r.getString(28,97).replace(/(^\s+|\s+$)/,""),u.v1.version=1.1,u.v1.track=r.getUint8(126)):u.v1.comment=r.getString(30,97).replace(/(^\s+|\s+$)/,""),u.v1.genre=ID3Genres[r.getUint8(127)]||null,g.v1=!0,c()}),o.read(14,0,function(e,t){if(e)return l("Could not read file");var r,i=new DataView(t),n=10,a=0;return 14!==t.byteLength||"ID3"!==i.getString(3,null,!0)||4<i.getUint8(3)?(g.v2=!0,c()):(u.v2.version=[i.getUint8(3),i.getUint8(4)],0!=(128&(r=i.getUint8(5)))?(g.v2=!0,c()):(0!=(64&r)&&(n+=i.getUint32Synch(11)),a+=i.getUint32Synch(6),void o.read(a,n,function(e,t){if(e)return g.v2=!0,c();for(var r=new DataView(t),i=0;i<t.byteLength;){for(var n,a,o,l=!0,s=0;s<3;s++)((o=r.getUint8(i+s))<65||90<o)&&(o<48||57<o)&&(l=!1);if(!l)break;a=u.v2.version[0]<3?t.slice(i,i+6+r.getUint24(i+3)):t.slice(i,i+10+r.getUint32Synch(i+4)),(n=ID3Frame.parse(a,u.v2.version[0]))&&(u.v2[n.tag]=n.value),i+=a.byteLength}g.v2=!0,c()})))})}};!function(){var a=function(e,r){var t={type:a.OPEN_URI};for(var i in"string"==typeof e?e={file:e,type:a.OPEN_URI}:"undefined"!=typeof window&&window.File&&e instanceof window.File&&(e={file:e,type:a.OPEN_FILE}),e)t[i]=e[i];if(!t.file)return r("No file was set");if(t.type===a.OPEN_FILE){if("undefined"==typeof window||!window.File||!window.FileReader||"undefined"==typeof ArrayBuffer)return r("Browser does not have support for the File API and/or ArrayBuffers")}else if(t.type===a.OPEN_LOCAL&&"function"!=typeof require)return r("Local paths may not be read within a browser");var n=new Reader(t.type);n.open(t.file,function(e){if(e)return r("Could not open specified file");ID3Tag.parse(n,function(e,t){r(e,t),n.close()})}),this.OPEN_FILE=Reader.OPEN_FILE,this.OPEN_URI=Reader.OPEN_URI,this.OPEN_LOCAL=Reader.OPEN_LOCAL};"undefined"!=typeof module&&module.exports?module.exports=a:"function"==typeof define&&define.amd?define("id3",[],function(){return a}):window.id3=a}();