/*
 * ID3 (v1/v2) Parser
 */(function(){var e=function(e,t){var n={type:"uri"};typeof e=="string"?e={file:e,type:"uri"}:typeof window!="undefined"&&window.File&&e instanceof window.File&&(e={file:e,type:"file"});for(var r in e)n[r]=e[r];if(!n.file)return t("No file was set");if(n.type==="file"){if(typeof window=="undefined"||!window.File||!window.FileReader||typeof ArrayBuffer=="undefined")return t("Browser does not have support for the File API and/or ArrayBuffers")}else if(n.type==="local"){if(typeof require!="function")return t("Local paths may not be read within a browser");var i=require("fs")}var s=["Blues","Classic Rock","Country","Dance","Disco","Funk","Grunge","Hip-Hop","Jazz","Metal","New Age","Oldies","Other","Pop","R&B","Rap","Reggae","Rock","Techno","Industrial","Alternative","Ska","Death Metal","Pranks","Soundtrack","Euro-Techno","Ambient","Trip-Hop","Vocal","Jazz+Funk","Fusion","Trance","Classical","Instrumental","Acid","House","Game","Sound Clip","Gospel","Noise","AlternRock","Bass","Soul","Punk","Space","Meditative","Instrumental Pop","Instrumental Rock","Ethnic","Gothic","Darkwave","Techno-Industrial","Electronic","Pop-Folk","Eurodance","Dream","Southern Rock","Comedy","Cult","Gangsta Rap","Top 40","Christian Rap","Pop / Funk","Jungle","Native American","Cabaret","New Wave","Psychedelic","Rave","Showtunes","Trailer","Lo-Fi","Tribal","Acid Punk","Acid Jazz","Polka","Retro","Musical","Rock & Roll","Hard Rock","Folk","Folk-Rock","National Folk","Swing","Fast  Fusion","Bebob","Latin","Revival","Celtic","Bluegrass","Avantgarde","Gothic Rock","Progressive Rock","Psychedelic Rock","Symphonic Rock","Slow Rock","Big Band","Chorus","Easy Listening","Acoustic","Humour","Speech","Chanson","Opera","Chamber Music","Sonata","Symphony","Booty Bass","Primus","Porn Groove","Satire","Slow Jam","Club","Tango","Samba","Folklore","Ballad","Power Ballad","Rhythmic Soul","Freestyle","Duet","Punk Rock","Drum Solo","A Cappella","Euro-House","Dance Hall","Goa","Drum & Bass","Club-House","Hardcore","Terror","Indie","BritPop","Negerpunk","Polsk Punk","Beat","Christian Gangsta Rap","Heavy Metal","Black Metal","Crossover","Contemporary Christian","Christian Rock","Merengue","Salsa","Thrash Metal","Anime","JPop","Synthpop","Rock/Pop"],o=function(e){this.type=e||"uri",this.size=null,this.file=null};o.prototype.open=function(e,t){this.file=e;var n=this;this.type==="local"?i.stat(this.file,function(e,r){if(e)return t(e);n.size=r.size,i.open(n.file,"r",function(e,r){if(e)return t(e);n.fd=r,t()})}):this.type==="file"?(this.size=this.file.size,t()):this.ajax({uri:this.file,type:"HEAD"},function(e,r,i){if(e)return t(e);n.size=parseInt(i.getResponseHeader("Content-Length")),t()})},o.prototype.close=function(){this.type==="local"&&i.close(this.fd)},o.prototype.read=function(e,t,n){this.type==="local"?this.readPath(e,t,n):this.type==="file"?this.readFile(e,t,n):this.readUri(e,t,n)},o.prototype.readPath=function(e,t,n){var r=new Buffer(e);i.read(this.fd,r,0,e,t,function(e,t,r){if(e)return n(e);var i=new ArrayBuffer(r.length),s=new Uint8Array(i);for(var o=0;o<r.length;o++)s[o]=r[o];n(null,i)})},o.prototype.ajax=function(e,t){var n={type:"GET",uri:null,responseType:"text"};typeof e=="string"&&(e={uri:e});for(var r in e)n[r]=e[r];var i=new XMLHttpRequest;i.onreadystatechange=function(){if(i.readyState!==4)return;if(i.status!==200&&i.status!==206)return t("Received non-200/206 response ("+i.status+")");t(null,i.response,i)},i.responseType=n.responseType,i.open(n.type,n.uri,!0),n.range&&(n.range=[].concat(n.range),n.range.length===2?i.setRequestHeader("Range","bytes="+n.range[0]+"-"+n.range[1]):i.setRequestHeader("Range","bytes="+n.range[0])),i.send()},o.prototype.readUri=function(e,t,n){this.ajax({uri:this.file,type:"GET",responseType:"arraybuffer",range:[t,t+e-1]},function(e,t){return e?n(e):n(null,t)})},o.prototype.readFile=function(e,t,n){var r=this.file.slice(t,t+e),i=new FileReader;i.onload=function(e){n(null,e.target.result)},i.onerror=function(e){n("File read failed")},i.readAsArrayBuffer(r)},DataView.prototype.getString=function(e,t){t=t||0,e=e||this.byteLength-t,e<0&&(e+=this.byteLength);var n="";for(var r=t;r<t+e;r++)n+=String.fromCharCode(this.getUint8(r));return decodeURIComponent(escape(n))},DataView.prototype.getStringUtf16=function(e,t,n){t=t||0,e=e||this.byteLength-t;var r=!1,i="";e<0&&(e+=this.byteLength);if(n){var s=this.getUint16(t);s===65534&&(r=!0),t+=2,e-=2}for(var o=t;o<t+e;o+=2){var u=this.getUint16(o,r);u>=0&&u<=55295||u>=57344&&u<=65535?i+=String.fromCharCode(u):u>=65536&&u<=1114111&&(u-=65536,i+=String.fromCharCode(((1047552&u)>>10)+55296)+String.fromCharCode((1023&u)+56320))}return decodeURIComponent(escape(i))},DataView.prototype.getSynch=function(e){var t=0,n=2130706432;while(n)t>>=1,t|=e&n,n>>=8;return t},DataView.prototype.getUint32Synch=function(e){return this.getSynch(this.getUint32(e))},DataView.prototype.getUint24=function(e){return this.getUint8(e+2)+(this.getUint8(e+1)<<8)+(this.getUint8(e)<<16)};var u={};u.types={TALB:"album",TBPM:"bpm",TCOM:"composer",TCON:"genre",TCOP:"copyright",TDEN:"encoding-time",TDLY:"playlist-delay",TDOR:"original-release-time",TDRC:"recording-time",TDRL:"release-time",TDTG:"tagging-time",TENC:"encoder",TEXT:"writer",TFLT:"file-type",TIPL:"involved-people",TIT1:"content-group",TIT2:"title",TIT3:"subtitle",TKEY:"initial-key",TLAN:"language",TLEN:"length",TMCL:"credits",TMED:"media-type",TMOO:"mood",TOAL:"original-album",TOFN:"original-filename",TOLY:"original-writer",TOPE:"original-artist",TOWN:"owner",TPE1:"artist",TPE2:"band",TPE3:"conductor",TPE4:"remixer",TPOS:"set-part",TPRO:"produced-notice",TPUB:"publisher",TRCK:"track",TRSN:"radio-name",TRSO:"radio-owner",TSOA:"album-sort",TSOP:"performer-sort",TSOT:"title-sort",TSRC:"isrc",TSSE:"encoder-settings",TSST:"set-subtitle",TAL:"album",TBP:"bpm",TCM:"composer",TCO:"genre",TCR:"copyright",TDY:"playlist-delay",TEN:"encoder",TFT:"file-type",TKE:"initial-key",TLA:"language",TLE:"length",TMT:"media-type",TOA:"original-artist",TOF:"original-filename",TOL:"original-writer",TOT:"original-album",TP1:"artist",TP2:"band",TP3:"conductor",TP4:"remixer",TPA:"set-part",TPB:"publisher",TRC:"isrc",TRK:"track",TSS:"encoder-settings",TT1:"content-group",TT2:"title",TT3:"subtitle",TXT:"writer",WCOM:"url-commercial",WCOP:"url-legal",WOAF:"url-file",WOAR:"url-artist",WOAS:"url-source",WORS:"url-radio",WPAY:"url-payment",WPUB:"url-publisher",WAF:"url-file",WAR:"url-artist",WAS:"url-source",WCM:"url-commercial",WCP:"url-copyright",WPB:"url-publisher",COMM:"comments",APIC:"image",PIC:"image"},u.imageTypes=["other","file-icon","icon","cover-front","cover-back","leaflet","media","artist-lead","artist","conductor","band","composer","writer","location","during-recording","during-performance","screen","fish","illustration","logo-band","logo-publisher"],u.parse=function(e,t,n){n=n||0,t=t||4;var r={tag:null,value:null},i=new DataView(e);if(t<3)return u.parseLegacy(e);var o={id:i.getString(4),type:i.getString(1),size:i.getUint32Synch(4),flags:[i.getUint8(8),i.getUint8(9)]};if(o.flags[1]!==0)return!1;if(!o.id in u.types)return!1;r.tag=u.types[o.id];if(o.type==="T"){var a=i.getUint8(10);if(a===0||a===3)r.value=i.getString(-11,11);else if(a===1)r.value=i.getStringUtf16(-11,11,!0);else{if(a!==2)return!1;r.value=i.getStringUtf16(-11,11)}o.id==="TCON"&&!!parseInt(r.value)&&(r.value=s[parseInt(r.value)])}else if(o.type==="W")r.value=i.getString(-10,10);else if(o.id==="COMM"){var a=i.getUint8(10),f=14,l=0;for(var c=f;;c++)if(a===1||a===2){if(i.getUint16(c)===0){f=c+2;break}c++}else if(i.getUint8(c)===0){f=c+1;break}if(a===0||a===3)r.value=i.getString(-1*f,f);else if(a===1)r.value=i.getStringUtf16(-1*f,f,!0);else{if(a!==2)return!1;r.value=i.getStringUtf16(-1*f,f)}}else if(o.id==="APIC"){var a=i.getUint8(10),h={type:null,mime:null,description:null,data:null},f=11,l=0;for(var c=f;;c++)if(i.getUint8(c)===0){l=c-f;break}h.mime=i.getString(l,f),h.type=u.imageTypes[i.getUint8(f+l+1)]||"other",f+=l+2,l=0;for(var c=f;;c++)if(i.getUint8(c)===0){l=c-f;break}h.description=l===0?null:i.getString(l,f),h.data=e.slice(f+1),r.value=h}return r.tag?r:!1},u.parseLegacy=function(e){var t={tag:null,value:null},n=new DataView(e),r={id:n.getString(3),type:n.getString(1),size:n.getUint24(3)};if(!r.id in u.types)return!1;t.tag=u.types[r.id];if(r.type==="T"){var i=n.getUint8(7);t.value=n.getString(-7,7),r.id==="TCO"&&!!parseInt(t.value)&&(t.value=s[parseInt(t.value)])}else if(r.type==="W")t.value=n.getString(-7,7);else if(r.id==="COM"){var i=n.getUint8(6);t.value=n.getString(-10,10),t.value.indexOf("\0")!==-1&&(t.value=t.value.substr(t.value.indexOf("\0")+1))}else if(r.id==="PIC"){var i=n.getUint8(6),o={type:null,mime:"image/"+n.getString(3,7).toLowerCase(),description:null,data:null};o.type=u.imageTypes[n.getUint8(11)]||"other";var a=11,f=0;for(var l=a;;l++)if(n.getUint8(l)===0){f=l-a;break}o.description=f===0?null:n.getString(f,a),o.data=e.slice(a+1),t.value=o}return t.tag?t:!1};var a={};a.parse=function(e,t){var n={title:null,album:null,artist:null,year:null,v1:{title:null,artist:null,album:null,year:null,comment:null,track:null,version:1},v2:{version:[null,null]}},r={v1:!1,v2:!1},i=function(){r.v1&&r.v2&&(n.title=n.v2.title||n.v1.title,n.album=n.v2.album||n.v1.album,n.artist=n.v2.artist||n.v1.artist,n.year=n.v1.year,t(null,n))};e.read(128,e.size-128,function(e,o){if(e)return t("Could not read file");var u=new DataView(o);if(o.byteLength!==128||u.getString(3)!=="TAG")return r.v1=!0,i();n.v1.title=u.getString(30,3).replace(/(^\s+|\s+$)/,"")||null,n.v1.artist=u.getString(30,33).replace(/(^\s+|\s+$)/,"")||null,n.v1.album=u.getString(30,63).replace(/(^\s+|\s+$)/,"")||null,n.v1.year=u.getString(4,93).replace(/(^\s+|\s+$)/,"")||null,u.getUint8(125)===0?(n.v1.comment=u.getString(28,97).replace(/(^\s+|\s+$)/,""),n.v1.version=1.1,n.v1.track=u.getUint8(126)):n.v1.comment=u.getString(30,97).replace(/(^\s+|\s+$)/,""),n.v1.genre=s[u.getUint8(127)]||null,r.v1=!0,i()}),e.read(14,0,function(s,o){if(s)return t("Could not read file");var a=new DataView(o),f=10,l=0,c;if(o.byteLength!==14||a.getString(3)!=="ID3"||a.getUint8(3)>4)return r.v2=!0,i();n.v2.version=[a.getUint8(3),a.getUint8(4)],c=a.getUint8(5);if((c&128)!==0)return r.v2=!0,i();(c&64)!==0&&(f+=a.getUint32Synch(11)),l+=a.getUint32Synch(6),e.read(l,f,function(e,t){if(e)return r.v2=!0,i();var s=new DataView(t),o=0;while(o<t.byteLength){var a,f,l,c=!0;for(var h=0;h<3;h++)l=s.getUint8(o+h),(l<65||l>90)&&(l<48||l>57)&&(c=!1);if(!c)break;n.v2.version[0]<3?f=t.slice(o,o+6+s.getUint24(o+3)):f=t.slice(o,o+10+s.getUint32Synch(o+4)),a=u.parse(f,n.v2.version[0]),a&&(n.v2[a.tag]=a.value),o+=f.byteLength}r.v2=!0,i()})})};var f=new o(n.type);f.open(n.file,function(e){if(e)return t("Could not open specified file");a.parse(f,function(e,n){t(e,n)})})};typeof module!="undefined"&&module.exports?module.exports=e:typeof define=="function"&&define.amd?define("id3",[],function(){return e}):window.id3=e})();